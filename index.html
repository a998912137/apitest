<script>
    const apiURL = "https://data.moa.gov.tw/service/opendata/ForestFireAlert.aspx";

    async function fetchLatestFireData() {
        try {
            console.log("開始抓取資料...");
            const response = await fetch(apiURL);
            
            if (!response.ok) throw new Error("API 回應異常");
            
            const data = await response.json(); 
            console.log("原始資料筆數:", data.length);

            // 效能優化：使用物件進行一次性篩選，避免多次排序
            const latestDataMap = {};
            
            data.forEach(item => {
                const stationName = item.name;
                [cite_start]const currentDate = item.CreateDate; // 格式如 20241007000000 [cite: 5]
                
                // 如果這個測站還沒存過，或是這筆資料比存過的還要新，就更新它
                if (!latestDataMap[stationName] || currentDate > latestDataMap[stationName].CreateDate) {
                    latestDataMap[stationName] = item;
                }
            });

            const tableBody = document.getElementById('table-body');
            const loading = document.getElementById('loading');
            const table = document.getElementById('fire-table');
            
            loading.style.display = 'none';
            table.style.display = 'table';

            // 轉為陣列並顯示
            const finalItems = Object.values(latestDataMap);
            document.getElementById('data-count').innerText = `目前顯示站點數：${finalItems.size || finalItems.length}`;

            finalItems.forEach(item => {
                const row = document.createElement('tr');
                
                [cite_start]// 處理警告等級顏色 [cite: 5]
                const warnText = item.warn_level_chinese || "無資料";
                let badgeClass = 'status-safe';
                if(warnText !== '安全') {
                    badgeClass = warnText.includes('注意') ? 'status-warn' : 'status-danger';
                }

                [cite_start]// 格式化日期：取出前 8 碼 [cite: 5]
                const d = item.CreateDate;
                const formattedDate = d ? `${d.substring(0,4)}-${d.substring(4,6)}-${d.substring(6,8)}` : "未知";

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td><span class="status-badge ${badgeClass}">${warnText}</span></td>
                    <td>${formattedDate}</td>
                `;
                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error("詳細錯誤訊息:", error);
            document.getElementById('loading').innerHTML = "資料處理出錯，請按 F12 檢查控制台。";
        }
    }

    fetchLatestFireData();
</script>
